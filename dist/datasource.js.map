{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","console","log","arguments","type","url","name","q","headers","basicAuth","length","options","query","sql","limit","offset","project","acceptPartial","target","Array","result","datasourceRequest","data","method","then","response","status","message","title","replace","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","interpolated","mapToTextValue","map","d","i","text","value","isObject","targets","filter","refId","hide"],"mappings":";;;;;;;;;;;;;;;AAAOA,I;;;;;;;;;;;;;;;;;;;;;gCAEMC,iB;AAEZ,+BAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,UAAlC,EAA8CC,WAA9C,EAA2D;AAAA;;AAC1DC,aAAQC,GAAR,CAAYC,SAAZ;AACA,UAAKC,IAAL,GAAYP,iBAAiBO,IAA7B;AACA,UAAKC,GAAL,GAAWR,iBAAiBQ,GAA5B;AACA,UAAKC,IAAL,GAAYT,iBAAiBS,IAA7B;AACA,UAAKC,CAAL,GAAST,EAAT;AACA,UAAKC,UAAL,GAAkBA,UAAlB;AACA,UAAKC,WAAL,GAAmBA,WAAnB;AACA,UAAKQ,OAAL,GAAe,EAAC,gBAAgB,kBAAjB,EAAf;AACA,SAAI,OAAOX,iBAAiBY,SAAxB,KAAsC,QAAtC,IAAkDZ,iBAAiBY,SAAjB,CAA2BC,MAA3B,GAAoC,CAA1F,EAA6F;AAC5F,WAAKF,OAAL,CAAa,eAAb,IAAgCX,iBAAiBY,SAAjD;AACA;AACD;;;;2BAEKE,O,EAAS;AACdV,cAAQC,GAAR,CAAY,eAAZ,EAA6BS,OAA7B;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,UAAIC,QAAQ;AACXC,YAAK,wEADM;AAEXC,cAAO,IAFI;AAGXC,eAAQ,CAHG;AAIXC,gBAAS,WAJE;AAKXC,sBAAe;AALJ,OAAZ;AAOA,UAAIC,SAASP,QAAQO,MAArB;AACA,UAAGA,kBAAkBC,KAAlB,IAA2BD,OAAOR,MAAP,GAAgB,CAA9C,EAAiD;AAChDE,eAAQM,OAAO,CAAP,CAAR;AACA;;AAEDjB,cAAQC,GAAR,CAAY,YAAZ,EAA0BU,KAA1B;AACA,UAAMQ,SAAS,KAAKrB,UAAL,CAAgBsB,iBAAhB,CAAkC;AAChDhB,YAAK,KAAKA,GAAL,GAAW,kBADgC;AAEhDiB,aAAMV,KAF0C;AAGhDW,eAAQ,MAHwC;AAIhDf,gBAAS,KAAKA;AAJkC,OAAlC,CAAf;AAMAP,cAAQC,GAAR,CAAY,QAAZ,EAAsBkB,MAAtB;AACA,aAAOA,MAAP;AACA;;;sCAEgB;AAChB,aAAO,KAAKrB,UAAL,CAAgBsB,iBAAhB,CAAkC;AACxChB,YAAK,KAAKA,GAAL,GAAW,gCADwB;AAExCkB,eAAQ,KAFgC;AAGxCf,gBAAS,KAAKA;AAH0B,OAAlC,EAIJgB,IAJI,CAIC,oBAAY;AACnB,WAAIC,SAASC,MAAT,KAAoB,GAAxB,EAA6B;AAC5B,eAAO,EAACA,QAAQ,SAAT,EAAoBC,SAAS,wBAA7B,EAAuDC,OAAO,SAA9D,EAAP;AACA;AACD,OARM,CAAP;AASA;;;qCAEejB,O,EAAS;AACxBV,cAAQC,GAAR,CAAY,kBAAZ,EAAgCS,OAAhC;AACA;AACA,UAAIC,QAAQ,KAAKZ,WAAL,CAAiB6B,OAAjB,CAAyBlB,QAAQmB,UAAR,CAAmBlB,KAA5C,EAAmD,EAAnD,EAAuD,MAAvD,CAAZ;AACA,UAAImB,kBAAkB;AACrBC,cAAOrB,QAAQqB,KADM;AAErBF,mBAAY;AACXxB,cAAMK,QAAQmB,UAAR,CAAmBxB,IADd;AAEX2B,oBAAYtB,QAAQmB,UAAR,CAAmBG,UAFpB;AAGXC,gBAAQvB,QAAQmB,UAAR,CAAmBI,MAHhB;AAIXC,mBAAWxB,QAAQmB,UAAR,CAAmBK,SAJnB;AAKXvB,eAAOA;AALI,QAFS;AASrBwB,iBAAUzB,QAAQyB;AATG,OAAtB;;AAYA,aAAO,KAAKrC,UAAL,CAAgBsB,iBAAhB,CAAkC;AACxChB,YAAK,KAAKA,GAAL,GAAW,cADwB;AAExCkB,eAAQ,MAFgC;AAGxCf,gBAAS,KAAKA,OAH0B;AAIxCc,aAAMS;AAJkC,OAAlC,EAKJP,IALI,CAKC,kBAAU;AACjB,cAAOJ,OAAOE,IAAd;AACA,OAPM,CAAP;AAQA;;;qCAEeX,O,EAAS;AACxBV,cAAQC,GAAR,CAAY,iBAAZ,EAA+BS,OAA/B;AACA;;AAEA,UAAIO,SAAS,OAAQP,OAAR,KAAqB,QAArB,GAAgCA,OAAhC,GAA0CA,QAAQO,MAA/D;AACA,UAAImB,eAAe;AAClBnB,eAAQ,KAAKlB,WAAL,CAAiB6B,OAAjB,CAAyBX,MAAzB,EAAiC,IAAjC,EAAuC,OAAvC;AADU,OAAnB;;AAIA,aAAO,KAAKnB,UAAL,CAAgBsB,iBAAhB,CAAkC;AACxChB,YAAK,KAAKA,GAAL,GAAW,SADwB;AAExCiB,aAAMe,YAFkC;AAGxCd,eAAQ,MAHgC;AAIxCf,gBAAS,KAAKA;AAJ0B,OAAlC,EAKJgB,IALI,CAKC,KAAKc,cALN,CAAP;AAMA;;;oCAEclB,M,EAAQ;AACtBnB,cAAQC,GAAR,CAAY,gBAAZ,EAA8BkB,MAA9B;AACA;;AAEA,aAAOzB,EAAE4C,GAAF,CAAMnB,OAAOE,IAAb,EAAmB,UAACkB,CAAD,EAAIC,CAAJ,EAAU;AACnC,WAAID,KAAKA,EAAEE,IAAP,IAAeF,EAAEG,KAArB,EAA4B;AAC3B,eAAO,EAACD,MAAMF,EAAEE,IAAT,EAAeC,OAAOH,EAAEG,KAAxB,EAAP;AACA,QAFD,MAEO,IAAIhD,EAAEiD,QAAF,CAAWJ,CAAX,CAAJ,EAAmB;AACzB,eAAO,EAACE,MAAMF,CAAP,EAAUG,OAAOF,CAAjB,EAAP;AACA;AACD,cAAO,EAACC,MAAMF,CAAP,EAAUG,OAAOH,CAAjB,EAAP;AACA,OAPM,CAAP;AAQA;;;0CAEoB7B,O,EAAS;AAAA;;AAC7B;AACAV,cAAQC,GAAR,CAAY,sBAAZ,EAAoCS,OAApC;AACA;;AAEAA,cAAQkC,OAAR,GAAkBlD,EAAEmD,MAAF,CAASnC,QAAQkC,OAAjB,EAA0B,kBAAU;AACrD,cAAO3B,OAAOA,MAAP,KAAkB,eAAzB;AACA,OAFiB,CAAlB;;AAIA,UAAI2B,UAAUlD,EAAE4C,GAAF,CAAM5B,QAAQkC,OAAd,EAAuB,kBAAU;AAC9C,cAAO;AACN3B,gBAAQ,MAAKlB,WAAL,CAAiB6B,OAAjB,CAAyBX,OAAOA,MAAhC,CADF;AAEN6B,eAAO7B,OAAO6B,KAFR;AAGNC,cAAM9B,OAAO8B,IAHP;AAIN5C,cAAMc,OAAOd,IAAP,IAAe;AAJf,QAAP;AAMA,OAPa,CAAd;;AASAO,cAAQkC,OAAR,GAAkBA,OAAlB;;AAEA,aAAOlC,OAAP;AACA","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n\tconstructor(instanceSettings, $q, backendSrv, templateSrv) {\n\t\tconsole.log(arguments);\n\t\tthis.type = instanceSettings.type;\n\t\tthis.url = instanceSettings.url;\n\t\tthis.name = instanceSettings.name;\n\t\tthis.q = $q;\n\t\tthis.backendSrv = backendSrv;\n\t\tthis.templateSrv = templateSrv;\n\t\tthis.headers = {'Content-Type': 'application/json'};\n\t\tif (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n\t\t\tthis.headers['Authorization'] = instanceSettings.basicAuth;\n\t\t}\n\t}\n\n\tquery(options) {\n\t\tconsole.log('query options', options);\n\t\t// var query = this.buildQueryParameters(options);\n\t\t// query.targets = query.targets.filter(t => !t.hide);\n\t\t//\n\t\t// if (query.targets.length <= 0) {\n\t\t// \treturn this.q.when({data: []});\n\t\t// }\n\n\t\tvar query = {\n\t\t\tsql: 'select hour_start,count(*) from db_channel.channel group by hour_start',\n\t\t\tlimit: 1000,\n\t\t\toffset: 0,\n\t\t\tproject: 'streaming',\n\t\t\tacceptPartial: true\n\t\t};\n\t\tvar target = options.target;\n\t\tif(target instanceof Array && target.length > 0) {\n\t\t\tquery = target[0];\n\t\t}\n\n\t\tconsole.log('query data', query);\n\t\tconst result = this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + '/kylin/api/query',\n\t\t\tdata: query,\n\t\t\tmethod: 'POST',\n\t\t\theaders: this.headers\n\t\t});\n\t\tconsole.log('result', result);\n\t\treturn result;\n\t}\n\n\ttestDatasource() {\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + '/kylin/api/user/authentication',\n\t\t\tmethod: 'GET',\n\t\t\theaders: this.headers\n\t\t}).then(response => {\n\t\t\tif (response.status === 200) {\n\t\t\t\treturn {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n\t\t\t}\n\t\t});\n\t}\n\n\tannotationQuery(options) {\n\t\tconsole.log('annotation query', options);\n\t\tdebugger;\n\t\tvar query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n\t\tvar annotationQuery = {\n\t\t\trange: options.range,\n\t\t\tannotation: {\n\t\t\t\tname: options.annotation.name,\n\t\t\t\tdatasource: options.annotation.datasource,\n\t\t\t\tenable: options.annotation.enable,\n\t\t\t\ticonColor: options.annotation.iconColor,\n\t\t\t\tquery: query\n\t\t\t},\n\t\t\trangeRaw: options.rangeRaw\n\t\t};\n\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + '/annotations',\n\t\t\tmethod: 'POST',\n\t\t\theaders: this.headers,\n\t\t\tdata: annotationQuery\n\t\t}).then(result => {\n\t\t\treturn result.data;\n\t\t});\n\t}\n\n\tmetricFindQuery(options) {\n\t\tconsole.log('metricFindQuery', options);\n\t\tdebugger;\n\n\t\tvar target = typeof (options) === \"string\" ? options : options.target;\n\t\tvar interpolated = {\n\t\t\ttarget: this.templateSrv.replace(target, null, 'regex')\n\t\t};\n\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + '/search',\n\t\t\tdata: interpolated,\n\t\t\tmethod: 'POST',\n\t\t\theaders: this.headers\n\t\t}).then(this.mapToTextValue);\n\t}\n\n\tmapToTextValue(result) {\n\t\tconsole.log('mapToTextValue', result);\n\t\tdebugger;\n\n\t\treturn _.map(result.data, (d, i) => {\n\t\t\tif (d && d.text && d.value) {\n\t\t\t\treturn {text: d.text, value: d.value};\n\t\t\t} else if (_.isObject(d)) {\n\t\t\t\treturn {text: d, value: i};\n\t\t\t}\n\t\t\treturn {text: d, value: d};\n\t\t});\n\t}\n\n\tbuildQueryParameters(options) {\n\t\t//remove placeholder targets\n\t\tconsole.log('buildQueryParameters', options);\n\t\tdebugger;\n\n\t\toptions.targets = _.filter(options.targets, target => {\n\t\t\treturn target.target !== 'select metric';\n\t\t});\n\n\t\tvar targets = _.map(options.targets, target => {\n\t\t\treturn {\n\t\t\t\ttarget: this.templateSrv.replace(target.target),\n\t\t\t\trefId: target.refId,\n\t\t\t\thide: target.hide,\n\t\t\t\ttype: target.type || 'timeserie'\n\t\t\t};\n\t\t});\n\n\t\toptions.targets = targets;\n\n\t\treturn options;\n\t}\n}\n"]}