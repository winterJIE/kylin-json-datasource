{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","headers","basicAuth","length","options","targets","Array","when","data","query","sql","limit","offset","project","acceptPartial","iterablePromise","target","queryData","push","getPromise","Promise","all","then","results","renderedData","i","result","dataPointArray","res","iRes","parseInt","Date","getTime","datapoints","catch","console","log","reason","datasourceRequest","method","response","status","message","title","interpolated","replace","mapToTextValue","map","d","text","value","isObject"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n\tconstructor(instanceSettings, $q, backendSrv, templateSrv) {\n\t\tthis.type = instanceSettings.type;\n\t\tthis.url = instanceSettings.url;\n\t\tthis.name = instanceSettings.name;\n\t\tthis.q = $q;\n\t\tthis.backendSrv = backendSrv;\n\t\tthis.templateSrv = templateSrv;\n\t\tthis.headers = {'Content-Type': 'application/json'};\n\t\tif (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n\t\t\tthis.headers['Authorization'] = instanceSettings.basicAuth;\n\t\t}\n\t}\n\n\tquery(options) {\n\t\tconst targets = options.targets;\n\n\t\tif (!(targets instanceof Array) || targets.length <= 0) {\n\t\t\treturn this.q.when({data: []});\n\t\t}\n\n\t\tconst url = '/kylin/api/query';\n\n\t\tconst query = {\n\t\t\tsql: 'select hour_start,count(*) from db_channel.channel group by hour_start',\n\t\t\tlimit: 1000,\n\t\t\toffset: 0,\n\t\t\tproject: 'streaming',\n\t\t\tacceptPartial: true\n\t\t};\n\t\tconst iterablePromise = [];\n\n\t\tfor (let target of targets) {\n\n\t\t\tconst queryData = {\n\t\t\t\tsql: target.sql,\n\t\t\t\tlimit: target.limit,\n\t\t\t\toffset: target.offset,\n\t\t\t\tproject: target.project,\n\t\t\t\tacceptPartial: target.acceptPartial\n\t\t\t};\n\n\t\t\titerablePromise.push(this.getPromise(url, queryData));\n\t\t}\n\n\t\treturn Promise.all(iterablePromise).then(function (results) {\n\n\t\t\tif (!results || results.length <= 0) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\tconst renderedData = [];\n\n\t\t\tfor(let i = 0; i< results.length; i++) {\n\n\t\t\t\tconst result = results[i];\n\t\t\t\tconst dataPointArray = [];\n\t\t\t\tconst res = result.data.results;\n\n\t\t\t\tfor (let iRes of res) {\n\t\t\t\t\tdataPointArray.push([parseInt(iRes[1], 10), new Date(iRes[0]).getTime()]);\n\t\t\t\t}\n\n\t\t\t\trenderedData.push({\n\t\t\t\t\tdatapoints: dataPointArray,\n\t\t\t\t\ttarget: targets[i].target\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn {data: renderedData};\n\t\t}).catch(reason => {\n\t\t\tconsole.log(reason)\n\t\t});\n\t}\n\n\tgetPromise(url, query) {\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + url,\n\t\t\tdata: query,\n\t\t\tmethod: 'POST',\n\t\t\theaders: this.headers\n\t\t})\n\t}\n\n\ttestDatasource() {\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + '/kylin/api/user/authentication',\n\t\t\tmethod: 'GET',\n\t\t\theaders: this.headers\n\t\t}).then(response => {\n\t\t\tif (response.status === 200) {\n\t\t\t\treturn {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n\t\t\t}\n\t\t});\n\t}\n\n\t// annotationQuery(options) {\n\t// \tconsole.log('annotation query', options);\n\t// \tdebugger;\n\t// \tvar query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n\t// \tvar annotationQuery = {\n\t// \t\trange: options.range,\n\t// \t\tannotation: {\n\t// \t\t\tname: options.annotation.name,\n\t// \t\t\tdatasource: options.annotation.datasource,\n\t// \t\t\tenable: options.annotation.enable,\n\t// \t\t\ticonColor: options.annotation.iconColor,\n\t// \t\t\tquery: query\n\t// \t\t},\n\t// \t\trangeRaw: options.rangeRaw\n\t// \t};\n\t//\n\t// \treturn this.backendSrv.datasourceRequest({\n\t// \t\turl: this.url + '/annotations',\n\t// \t\tmethod: 'POST',\n\t// \t\theaders: this.headers,\n\t// \t\tdata: annotationQuery\n\t// \t}).then(result => {\n\t// \t\treturn result.data;\n\t// \t});\n\t// }\n\n\tmetricFindQuery(options) {\n\t\tconsole.log('metricFindQuery', options);\n\n\t\tconst target = typeof (options) === \"string\" ? options : options.target;\n\t\tconst interpolated = {\n\t\t\ttarget: this.templateSrv.replace(target, null, 'regex')\n\t\t};\n\n\t\treturn this.backendSrv.datasourceRequest({\n\t\t\turl: this.url + '/search',\n\t\t\tdata: interpolated,\n\t\t\tmethod: 'POST',\n\t\t\theaders: this.headers\n\t\t}).then(this.mapToTextValue);\n\t}\n\n\tmapToTextValue(result) {\n\t\tconsole.log('mapToTextValue', result);\n\n\t\treturn _.map(result.data, (d, i) => {\n\t\t\tif (d && d.text && d.value) {\n\t\t\t\treturn {text: d.text, value: d.value};\n\t\t\t} else if (_.isObject(d)) {\n\t\t\t\treturn {text: d, value: i};\n\t\t\t}\n\t\t\treturn {text: d, value: d};\n\t\t});\n\t}\n\n\t// buildQueryParameters(options) {\n\t// \t//remove placeholder targets\n\t// \tconsole.log('buildQueryParameters', options);\n\t// \tdebugger;\n\t//\n\t// \toptions.targets = _.filter(options.targets, target => {\n\t// \t\treturn target.target !== 'select metric';\n\t// \t});\n\t//\n\t// \tvar targets = _.map(options.targets, target => {\n\t// \t\treturn {\n\t// \t\t\ttarget: this.templateSrv.replace(target.target),\n\t// \t\t\trefId: target.refId,\n\t// \t\t\thide: target.hide,\n\t// \t\t\ttype: target.type || 'timeserie'\n\t// \t\t};\n\t// \t});\n\t//\n\t// \toptions.targets = targets;\n\t//\n\t// \treturn options;\n\t// }\n}\n"]}